<template>
  <template if:true={isAuthorized}>
    <c-logout-button></c-logout-button>
    <lightning-card title="Fill Survey" icon-name="utility:poll">
      <div class="slds-p-around_medium">

        <!-- Przycisk do zmiany sortowania -->
        <lightning-button-icon
          icon-name={sortIcon}
          alternative-text="Zmień sortowanie"
          onclick={toggleSortDirection}
          class="slds-m-bottom_small">
        </lightning-button-icon>

        <!-- Filtrowanie po statusie -->
        <lightning-combobox
          label="Filtruj ankiety"
          value={selectedStatus}
          options={statusOptions}
          onchange={handleStatusChange}
          class="slds-m-bottom_small">
        </lightning-combobox>

        <!-- Lista ankiet -->
        <template if:true={surveys}>
          <p class="slds-text-heading_small">Wybierz ankietę:</p>
          <template for:each={filteredSurveys} for:item="s">
            <div key={s.Id} class="slds-box slds-m-around_small">
              <p><strong>{s.Title_c__c}</strong></p>
              <p>Zakończenie:
                <lightning-formatted-date-time
                  value={s.End_Date__c}
                  year="numeric"
                  month="2-digit"
                  day="2-digit"
                  hour="2-digit"
                  minute="2-digit">
                </lightning-formatted-date-time>
              </p>

              <!-- Obsługa przycisków -->
              <template if:false={s.isExpired}>
                <template if:false={s.alreadySubmitted}>
                  <lightning-button
                    label="Wypełnij"
                    data-id={s.Id}
                    onclick={handleSurveyClick}
                    class="slds-m-top_x-small">
                  </lightning-button>
                </template>
                <template if:true={s.alreadySubmitted}>
                  <p class="slds-text-color_success slds-m-top_x-small">
                    Już wypełniono
                  </p>
                </template>
              </template>

              <template if:true={s.isExpired}>
                <p class="slds-text-color_error slds-m-top_x-small">
                  Ankieta zakończona
                </p>
              </template>
            </div>
          </template>
        </template>

        <!-- Pytania ankiety -->
        <template if:true={questions}>
          <template if:true={isSurveyExpired}>
            <p class="slds-text-color_error slds-m-top_medium">
              Ta ankieta jest już zakończona. Nie można jej wypełnić.
            </p>
          </template>
          <template if:false={isSurveyExpired}>
            <template for:each={questions} for:item="q">
              <div key={q.Id} class="slds-box slds-m-top_medium">
                <p class="slds-text-heading_small">{q.Question_Text__c}</p>
                <lightning-radio-group
                  name={q.Id}
                  options={q.options}
                  value={q.selected}
                  data-qid={q.Id}
                  onchange={handleResponse}>
                </lightning-radio-group>
              </div>
            </template>

            <lightning-button
              variant="brand"
              label="Submit Responses"
              class="slds-m-top_medium"
              onclick={submitResponses}>
            </lightning-button>
          </template>
        </template>

      </div>
    </lightning-card>
  </template>
</template>
